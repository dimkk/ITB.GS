(function(){function w(n){if(n!==undefined){var t=n.getDate(),i=n.getMonth()+1,u=n.getFullYear(),f=n.getHours(),r=n.getMinutes();return t<10&&(t="0"+t),i<10&&(i="0"+i),r<10&&(r="0"+r),t+"."+i+"."+u+" "+f+":"+r}}function it(n){if(n!==undefined){var t=n.split("/");return new Date(+t[2],t[1]-1,+t[0])}}function b(n){return n!=""&&!isNaN(n)}function rt(n,t,i){var u,r;return t==null||t==""?null:(u=$.grep(n,function(n){return n.name==t}),u.length==0)?(r=i.addItem(new SP.ListItemCreationInformation),r.set_item("Title",t),r.update(),$.appWebContext.load(r),t):null}function ut(n,t){for(var f,r,u=[{name:"Выберите значение..."}],i=0;i<n.length;i++)if(n[i].get_internalName()==t){for(f=n[i].get_choices(),r=0;r<f.length;r++)u.push({name:f[r]});return u}return u}function ft(n){var i=_spPageContextInfo.webAbsoluteUrl+"/_api/web/lists/getByTitle('ConfigurationList')/items(1)",r={__metadata:{type:"SP.Data.ConfigurationListListItem"},CurrentMeetingNumber:n},t=JSON.stringify(r);$.ajax({url:encodeURI(i),data:t,headers:{accept:"application/json;odata=verbose","X-RequestDigest":$("#__REQUESTDIGEST").val(),"X-HTTP-Method":"MERGE","content-length":t.length,"content-type":"application/json;odata=verbose","If-Match":"*"},type:"POST",async:!1,success:function(){}})}function et(){var n=0,t=_spPageContextInfo.webAbsoluteUrl+"/_api/web/lists/getByTitle('ConfigurationList')/items(1)";return $.ajax({url:encodeURI(t),headers:{Accept:"application/json;odata=verbose"},method:"GET",async:!1,success:function(t){t.d&&(n=t.d.CurrentMeetingNumber)}}),n}function ot(n){for(var i="",r=new window.Uint8Array(n),u=r.byteLength,t=0;t<u;t++)i+=String.fromCharCode(r[t]);return i}function st(n){var u=$.appWebContext.get_web().get_lists().getByTitle("Вложения отчета по поручению"),e=[],o,f,s,r,h,i,t;for(o in n){f=n[o];for(s in f.assignmentReports()){r=f.assignmentReports()[s];for(h in r.reportAttachments())i=r.reportAttachments()[h],i._destroy?i.Id()!=""&&(t=u.getItemById(i.Id()),t.deleteObject()):i.Id()==""?(t=u.addItem(new SP.ListItemCreationInformation),t.set_item("AttachmentDescription",i.Descr()),t.set_item("AssignmentReportLink",r.Id()),t.set_item("AttachmentDocumentTypeLink",i.DType()),t.set_item("AttachmentIsForReport",i.IsForReport()),t.update(),e.push({spItem:t,koItem:i}),$.appWebContext.load(t)):(t=u.getItemById(i.Id()),t.set_item("AttachmentDescription",i.Descr()),t.set_item("AttachmentDocumentTypeLink",i.DType()),t.update())}}return e}function ht(){$.ajax({url:encodeURI(_spPageContextInfo.webAbsoluteUrl+"/_api/web/getuserbyid("+_spPageContextInfo.userId+")"),contentType:"application/json;odata=verbose",headers:{accept:"application/json;odata=verbose"},success:function(n){n.d&&(p=n.d)},error:function(){}})}function l(n,t){var i,r,u;for(i in n){if(n[i].koItem.Id(n[i].spItem.get_id()),n[i].koItem.New=!1,r=new window.FileReader,u=n[i].koItem.File(),u==undefined)return;r.onerror=function(){alert("File read failed")};r.onload=function(n,i){var r=n.spItem.get_id(),u=i;return function(i){var f=ot(i.target.result),e="/_api/web/lists/GetByTitle('"+t+"')/items("+r+")/AttachmentFiles/add(FileName='"+u+"')",o=new SP.RequestExecutor(_spPageContextInfo.webAbsoluteUrl);o.executeAsync({url:_spPageContextInfo.webAbsoluteUrl+e,method:"POST",headers:{Accept:"application/json; odata=verbose"},binaryStringRequestBody:!0,body:f,state:"Update",success:function(n){return function(t){var i=JSON.parse(t.body);n.koItem.FileName(i.d.FileName);n.koItem.FileUrl(_spPageContextInfo.siteAbsoluteUrl+i.d.ServerRelativeUrl)}}(n)})}}(n[i],u.name);r.readAsArrayBuffer(u)}}function ct(n){var u=$.appWebContext.get_web().get_lists().getByTitle("Записи журналов поручений"),t,i,r;for(t in n)for(i in n[t].assignmentJournal())n[t].assignmentJournal()[i].New&&(r=u.addItem(new SP.ListItemCreationInformation),r.set_item("AssignmentLink",n[t].Id()),r.set_item("AssignmentJournalEntryDescr",n[t].assignmentJournal()[i].AssignmentJournalEntryDescr()),r.update(),n[t].assignmentJournal()[i].New=!1)}function lt(t){var e=$.appWebContext.get_web().get_lists().getByTitle("Отчеты по поручениям"),o=[],f,s,r,i;for(f in t)for(s in t[f].assignmentReports())r=t[f].assignmentReports()[s],r._destroy?r.Id()!=""&&(i=e.getItemById(r.Id()),i.deleteObject()):r.Id()==""?(i=e.addItem(new SP.ListItemCreationInformation),u(n.assignmentReport.fields,r,i),i.set_item("AssignmentLink",t[f].Id()),i.update(),o.push({spItem:i,koItem:r}),$.appWebContext.load(i)):(i=e.getItemById(r.Id()),u(n.assignmentReport.fields,r,i),i.update());return o}function at(t,i){var l=null,o,s,h,c,a;if(t!="AssignmentLink"&&t!="AssignmentDependencyType"){var r=i[t]()==null?"":i[t](),u=i["edit"+t]()==null?"":i["edit"+t](),f="";switch(t){case"AssignmentNumber":r.toString()!=u.toString()&&(f="Номер - "+r.toString()+" -> "+u.toString());break;case"AssignmentText":r.toString()!=u.toString()&&(f="Текст поручения - "+r.toString()+" -> "+u.toString());break;case"AssignmentNote":r.toString()!=u.toString()&&(f="Примечание - "+r.toString()+" -> "+u.toString());break;case"AssignmentPredecessorLinkValue":r.toString()!=u.toString()&&(f="Зависимое поручение - "+r.toString()+" -> "+u.toString());break;case"AssignmentCreationDate":r.toString()!=u.toString()&&(f="Дата создания - "+r.toString()+" -> "+u.toString());break;case"AssignmentPlanDate":r.toString()!=u.toString()&&(f="Планируемая дата исполнения - "+r.toString()+" -> "+u.toString());break;case"AssignmentFactDate":r.toString()!=u.toString()&&(f="Фактическая дата исполнения - "+r.toString()+" -> "+u.toString());break;case"AssignmentDaysForResolve":r.toString()!=u.toString()&&(f="Количество дней на решение - "+r.toString()+" -> "+u.toString());break;case"AssignmentStatus":r.toString()!=u.toString()&&(f="Статус - "+r.toString()+" -> "+u.toString());break;case"AssignmentInspectState":r.toString()!=u.toString()&&(f="Состояние контроля - "+r.toString()+" -> "+u.toString());break;case"AssignmentDayType":r.toString()!=u.toString()&&(f="Тип дней - "+r.toString()+" -> "+u.toString());break;case"AssignmentExecutorFullNameLink":o=i.AssignmentExecutorFullNameLinkValue()==null?"":i.AssignmentExecutorFullNameLinkValue().toString();s=i.editAssignmentExecutorFullNameLinkValue()==null?"":i.editAssignmentExecutorFullNameLinkValue().toString();o!=s&&(f="Исполнитель - "+o+" -> "+s);break;case"AgendaQuestionLink":o=i.AgendaQuestionLinkValue()==null?"":i.AgendaQuestionLinkValue().toString();s=i.editAgendaQuestionLinkValue()==null?"":i.editAgendaQuestionLinkValue().toString();o!=s&&(f="Вопрос повестки - "+o+" -> "+s);break;case"AssignmentSoexecutors":r.toString()!=u.toString()&&(f="Соисполнители")}f!=""&&(h=e(n.assignmentJournal.fields),c=p.LoginName.split("|"),h.Author=c.length>1?c[1]:c[0],a=new Date,h.CreatedDate=a.format("dd/MM/yy"),l=new ni(h),l.AssignmentJournalEntryDescr(f))}return l}function f(n,i,r){var u={title:n,url:r?_spPageContextInfo.webAbsoluteUrl+"/_layouts/15/gradsovetpages/Pages/ParticipantsSelection.aspx?Multi=1":_spPageContextInfo.webAbsoluteUrl+"/_layouts/15/gradsovetpages/Pages/ParticipantsSelection.aspx",width:800,height:400,dialogReturnValueCallback:function(n,t){h(n,t,i)}};SP.UI.ModalDialog.showModalDialog(u);t()}function vt(n,i){var r={title:n,url:_spPageContextInfo.webAbsoluteUrl+String.format("/_layouts/15/gradsovetpages/Pages/AgendaQuestionAttach.aspx?ID={0}",i),width:800,height:400,dialogReturnValueCallback:function(){}};SP.UI.ModalDialog.showModalDialog(r);t()}function yt(n,i){var r,u;i.agendaQuestionObjects().length!=0&&(r=_spPageContextInfo.webAbsoluteUrl,r=i.agendaQuestionObjects().length>1?r+String.format("/Lists/AgendaQuestionObjectList/AllItems.aspx?FilterField1=_x0412__x043e__x043f__x0440__x041&FilterValue1={0}",i.Id()):r+String.format("/Lists/Object/DispForm.aspx?ID={0}",i.agendaQuestionObjects()[0]._x041e__x0431__x044a__x0435__x04().get_lookupId()),u={title:n,url:r,width:1024,height:768,autoSize:!1,allowMaximize:!0,dialogReturnValueCallback:function(){}},SP.UI.ModalDialog.showModalDialog(u),t())}function pt(n){var i={title:n,url:_spPageContextInfo.webAbsoluteUrl+"/Lists/IssuePList/Unused.aspx",width:1024,height:768,dialogReturnValueCallback:function(n,t){var i,u,r;if(n==SP.UI.DialogResult.OK){if(i=JSON.parse(t),i.length<=0)return;console.log(i);u=_spPageContextInfo.serverRequestPath+"/AddIssuesP";r={meetingGsId:$.listItemId};r.issuePIdList=[];i.map(function(n){r.issuePIdList.push(n.id)});$.ajax({url:encodeURI(u),data:JSON.stringify(r),contentType:"application/json; charset=utf-8",dataType:"json",type:"POST",success:function(t){console.log(t);SP.UI.ModalDialog.RefreshPage(n)},error:function(n){console.log("RequestError! "+n)}})}}};SP.UI.ModalDialog.showModalDialog(i);t()}function s(n){var t=new SP.FieldLookupValue;return t.set_lookupId(n),t}function t(){}function h(n,t,i){n==SP.UI.DialogResult.OK&&$(i).val(t).change()}function wt(t){for(var i in n)n[i].contentTypes=$.appWebContext.get_web().get_lists().getByTitle(n[i].listName).get_contentTypes(),$.appWebContext.load(n[i].contentTypes);$.appWebContext.executeQueryAsync(function(){var i,r;for(i in n){for(r=0;r<n[i].contentTypes.get_count();r++)if(n[i].contentTypes.getItemAtIndex(r).get_name()==n[i].ctName){n[i].contentType=n[i].contentTypes.getItemAtIndex(r);break}n[i].fields=n[i].contentType.get_fields();$.appWebContext.load(n[i].fields)}$.appWebContext.executeQueryAsync(function(){var i,u,r,f;for(i in n){for(u=[],r=0;r<n[i].fields.get_count();r++)f=n[i].fields.getItemAtIndex(r).get_internalName(),u.push(n[i].fields.getItemAtIndex(r));n[i].fields=u}t([])},function(){t([])})},function(){t([])})}function k(n,t){var i={FileUrl:"",FileName:""},r=_spPageContextInfo.webAbsoluteUrl+"/_api/web/lists/getByTitle('"+n+"')/items("+t+")/AttachmentFiles";return $.ajax({url:encodeURI(r),headers:{Accept:"application/json;odata=verbose"},method:"GET",async:!1,success:function(n){n&&n.d.results.length>0&&(i.FileUrl=_spPageContextInfo.siteAbsoluteUrl+n.d.results[0].ServerRelativeUrl,i.FileName=n.d.results[0].FileName)}}),i}function bt(n){var t=[],u=_spPageContextInfo.webAbsoluteUrl+"/_api/web/lists/getByTitle('Вложения отчета по поручению')/items?$select=ID,AssignmentReportLink/Id,AttachmentDescription,AttachmentDocumentTypeLink/Id,AttachmentIsForReport&$expand=AttachmentFiles,AssignmentReportLink,AttachmentDocumentTypeLink&$filter=AssignmentReportLink/Id eq "+n;return $.ajax({url:encodeURI(u),headers:{Accept:"application/json;odata=verbose"},method:"GET",async:!1,success:function(n){if(n)for(i=0;i<n.d.results.length;i++){var u=k("Вложения отчета по поручению",n.d.results[i].ID);t.push(new r({AttachmentDescription:n.d.results[i].AttachmentDescription,MeetingLink:n.d.results[i].AssignmentReportLink.Id,Id:n.d.results[i].ID,FileUrl:u.FileUrl,FileName:u.FileName,FilePath:"",AttachmentDocumentTypeLinkValue:n.d.results[i].AttachmentDocumentTypeLink.Id?n.d.results[i].AttachmentDocumentTypeLink.Id:"",AttachmentIsForReport:n.d.results[i].AttachmentIsForReport,New:!1}))}}}),t}function d(n){var u=[],f;if(n!=null){var r="",t=[];if($.each(n,function(){t.push(this.get_lookupId())}),t=$.unique(t),t.length>0)r="&$filter=Id eq "+t[0];else return[];for(i=1;i<t.length;i++)r+="or Id eq "+t[i];f=_spPageContextInfo.webAbsoluteUrl+"/_api/web/lists/getByTitle('Справочник участников')/items?$select=ParticipantFullName,ParticipantPositionLink/Title,ParticipantOrgLink/OrganizationName,ParticipantRole,ID&$expand=ParticipantPositionLink,ParticipantOrgLink"+r;$.ajax({url:encodeURI(f),headers:{Accept:"application/json;odata=verbose"},method:"GET",async:!1,success:function(n){if(n.d)for(i=0;i<n.d.results.length;i++)u.push(new c(n.d.results[i]))}})}return u}function kt(n){this.Id=n.Id;this.Name=n.QuestionCategoryName}function dt(n){this.Id=n.Id;this.Value=n.Value;this.Unit=n.Unit}function gt(n){this.Id=n.Id;this.AssignmentTypeName=n.AssignmentTypeName;this.AssignmentTypeDescr=n.AssignmentTypeDescr}function a(n){var t,i;for(t in n)t=="New"?this[t]=n[t]:t=="Id"?this[t]=ko.observable(n[t]):(t.toLowerCase().endsWith("link")&&(this[t+"Value"]=ko.observable(n[t]?n[t].get_lookupValue():null),this[t+"Id"]=ko.observable(n[t]?n[t].get_lookupId():null),this["edit"+t+"Value"]=ko.observable(n[t]?n[t].get_lookupValue():null),this["edit"+t+"Id"]=ko.observable(n[t]?n[t].get_lookupId():null)),this[t]=ko.observable(n[t]),this["edit"+t]=ko.observable(n[t]));i=this.Id()>0?bt(this.Id()):null;this.reportAttachments=i!=null?ko.observableArray(i):ko.observableArray([]);this.editReportAttachments=i!=null?ko.observableArray(i):ko.observableArray([]);this.editReportAttachmentsFiltered=function(){return ko.utils.arrayFilter(this.editReportAttachments(),function(n){return n.IsForReport()})};this.editRequestAttachmentsFiltered=function(){return ko.utils.arrayFilter(this.editReportAttachments(),function(n){return!n.IsForReport()})};this.removeReportAttach=function(n){this.editReportAttachments.destroy(n)}.bind(this);this.addRequestAttach=function(){this.doAddReportAttach(!1)};this.addReportAttach=function(){this.doAddReportAttach(!0)};this.doAddReportAttach=function(n){this.editReportAttachments.push(new r({Id:"",AttachmentDescription:"",MeetingLink:this.Id(),FileUrl:"",FileName:"",FilePath:"",AttachmentDocumentTypeLinkValue:"",AttachmentIsForReport:n,New:!0}))}.bind(this);this.accept=function(){for(var t in n)t!="New"&&t!="Id"&&(t.toLowerCase().endsWith("link")&&(this[t+"Value"](this["edit"+t+"Value"]()),this[t+"Id"](this["edit"+t+"Id"]())),this[t](this["edit"+t]()));this.reportAttachments(this.editReportAttachments())}.bind(this);this.cancel=function(){for(var t in n)t!="New"&&t!="Id"&&(t.toLowerCase().endsWith("link")&&(this["edit"+t+"Value"](this[t+"Value"]()),this["edit"+t+"Id"](this[t+"Id"]())),this["edit"+t](this[t]()));this.editReportAttachments(this.reportAttachments())}.bind(this)}function ni(n){for(var t in n)this[t]=t=="New"?n[t]:ko.observable(n[t])}function ti(r){var u=this;for(var f in r)f=="New"?u[f]=r[f]:f=="Id"?u[f]=ko.observable(r[f]):(f.toLowerCase().endsWith("link")&&(u[f+"Value"]=ko.observable(r[f]?r[f].get_lookupValue():null),u[f+"Id"]=ko.observable(r[f]?r[f].get_lookupId():null),u["edit"+f+"Value"]=ko.observable(r[f]?r[f].get_lookupValue():null),u["edit"+f+"Id"]=ko.observable(r[f]?r[f].get_lookupId():null)),u[f]=ko.observable(r[f]),u["edit"+f]=ko.observable(r[f]));u.selectedRequest=ko.observable(undefined);u.assignmentReports=ko.observableArray([]);u.assignmentJournal=ko.observableArray([]);u.editAssignmentReports=ko.observableArray([]);u.changedExecutor=ko.observable("");u.changedExecutorIsNull=ko.computed(function(){return!(u.editAssignmentExecutorFullNameLinkValue()||u.editAssignmentExecutorPositionLinkValue()||u.editAssignmentExecutorOrganizationLinkValue())},u);u.changedSoexecutors=ko.observable("");u.assignmentSoexecutors=ko.observableArray([]);u.changedAssignmentSoexecutors=ko.observableArray([]);u.loadExecutor=function(){if(u.editAssignmentExecutorFullNameLink()!=null){var n=$.grep(o,function(n){return n.Id().toString()==u.editAssignmentExecutorFullNameLinkId().toString()});n.length>0&&(u.AssignmentExecutorPositionLinkValue(n[0].ParticipantPosition()),u.editAssignmentExecutorPositionLinkValue(n[0].ParticipantPosition()),u.AssignmentExecutorOrganizationLinkValue(n[0].ParticipantOrg()),u.editAssignmentExecutorOrganizationLinkValue(n[0].ParticipantOrg()))}}.bind(u);u.loadSoexecutors=function(){if(u.AssignmentSoexecutors()!=null){var n=[];$.each(u.AssignmentSoexecutors(),function(){var i=this.get_lookupId(),t=$.grep(o,function(n){return n.Id().toString()==i.toString()});t.length>0&&n.push(t[0])});u.assignmentSoexecutors(n);u.changedAssignmentSoexecutors(n)}}.bind(u);u.selectExecutor=function(){var n={title:"Выбор исполнителя",url:_spPageContextInfo.webAbsoluteUrl+"/_layouts/15/gradsovetpages/Pages/ExecutorSelection.aspx",width:800,height:400,dialogReturnValueCallback:function(n,t){h(n,t,"#hiddenExecutor")}};SP.UI.ModalDialog.showModalDialog(n);t()}.bind(u);u.selectSoexecutors=function(){var n={title:"Выбор соисполнителей",url:_spPageContextInfo.webAbsoluteUrl+"/_layouts/15/gradsovetpages/Pages/ParticipantsSelection.aspx?Multi=1",width:800,height:400,dialogReturnValueCallback:function(n,t){h(n,t,"#hiddenSoexecutors")}};SP.UI.ModalDialog.showModalDialog(n);t()}.bind(u);u.onSoexecutorsChange=ko.computed(function(){var n,t,r;if(u.changedSoexecutors()!=""){for(n=$.parseJSON(u.changedSoexecutors()),i=0;i<n.length;i++)t=new c(n[i]),ko.utils.arrayFirst(u.changedAssignmentSoexecutors(),function(n){return t.Id()==n.Id()})||(u.changedAssignmentSoexecutors.push(t),u.editAssignmentSoexecutors()==null&&u.editAssignmentSoexecutors([]),r=new SP.FieldLookupValue,r.set_lookupId(n[i].Id),u.editAssignmentSoexecutors().push(r));u.changedSoexecutors("")}},u);u.onExecutorChange=ko.computed(function(){if(u.changedExecutor()!=""){var n=$.parseJSON(u.changedExecutor()),t=new SP.FieldLookupValue;t.set_lookupId(n.Id);u.editAssignmentExecutorFullNameLinkValue(n.FullName);u.editAssignmentExecutorFullNameLinkId(n.Id);u.editAssignmentExecutorPositionLinkValue(n.Position);u.editAssignmentExecutorPositionLinkId(n.Id);u.editAssignmentExecutorOrganizationLinkValue(n.Org);u.editAssignmentExecutorOrganizationLinkId(n.Id);switch(n.ExecutorType){case"FIO":u.editAssignmentExecutorFullNameLink(t);u.editAssignmentExecutorPositionLink(null);u.editAssignmentExecutorOrganizationLink(null);break;case"Position":u.editAssignmentExecutorFullNameLink(null);u.editAssignmentExecutorPositionLink(t);u.editAssignmentExecutorOrganizationLink(null);break;case"Organization":u.editAssignmentExecutorFullNameLink(null);u.editAssignmentExecutorPositionLink(null);u.editAssignmentExecutorOrganizationLink(t)}u.changedExecutor("")}},u);u.accept=function(){var n,t;for(n in r)n!="New"&&n!="Id"&&(t=at(n,u),t!=null&&u.assignmentJournal.push(t),n.toLowerCase().endsWith("link")&&(u[n+"Value"](u["edit"+n+"Value"]()),u[n+"Id"](u["edit"+n+"Id"]())),u[n](u["edit"+n]()));u.assignmentSoexecutors(u.changedAssignmentSoexecutors());u.assignmentReports(u.editAssignmentReports())}.bind(u);u.cancel=function(){for(var n in r)n!="New"&&n!="Id"&&(n.toLowerCase().endsWith("link")&&(u["edit"+n+"Value"](u[n+"Value"]()),u["edit"+n+"Id"](u[n+"Id"]())),u["edit"+n](u[n]()));u.changedAssignmentSoexecutors(u.assignmentSoexecutors());u.editAssignmentReports(u.assignmentReports())}.bind(u);u.assignmentTypeComputed=ko.computed({read:function(){return u.editAssignmentTypeLink()?u.editAssignmentTypeLink().get_lookupId():""},write:function(n){u.editAssignmentTypeLink(s(n));u.editAssignmentTypeLinkId(n)}},u);u.removeAssignSoexecutor=function(n){u.changedAssignmentSoexecutors.remove(n);this.editAssignmentSoexecutors($.grep(this.editAssignmentSoexecutors(),function(t){return t.get_lookupId().toString()!=n.Id().toString()}))}.bind(u);u.removeRequest=function(n){u.editAssignmentReports.destroy(n)}.bind(u);u.editRequest=function(n){u.selectedRequest(n)}.bind(u);u.acceptRequest=function(){var t=u.selectedRequest(),i,r;t.accept();t.New&&(i=nt(n.assignmentReport.fields,t),i.Id="",i.New=!1,r=new a(i),r.reportAttachments(t.reportAttachments()),r.editReportAttachments(t.reportAttachments()),u.editAssignmentReports.push(r));u.selectedRequest(undefined)};u.cancelRequest=function(){u.selectedRequest().cancel();u.selectedRequest(undefined)};u.addRequest=function(){var t=e(n.assignmentReport.fields),i=new Date;t.AssignmentReportRequestDate=i.format("dd/MM/yyyy");u.selectedRequest(new a(t));selectRequestsTab("tab-request-request")};u.addReport=function(){var t=e(n.assignmentReport.fields),i=new Date;t.AssignmentReportFactAnswerDate=i.format("dd/MM/yyyy");u.selectedRequest(new a(t));selectRequestsTab("tab-request-report")}}function v(u){for(var e in u)e=="New"?this[e]=u[e]:e=="Id"?this[e]=ko.observable(u[e]):(this[e]=ko.observable(u[e]),this["edit"+e]=ko.observable(u[e]),e=="AgendaLinkedQuestionLink"&&(this[e+"Value"]=ko.observable(u[e]?u[e].get_lookupValue():null),this[e+"Id"]=ko.observable(u[e]?u[e].get_lookupId():null),this["edit"+e+"Value"]=ko.observable(u[e]?u[e].get_lookupValue():null),this["edit"+e+"Id"]=ko.observable(u[e]?u[e].get_lookupId():null)));this.calcContent=ko.computed(function(){var n="";return n+=this.AgendaQuestionSiteName()?"Объект: "+this.AgendaQuestionSiteName()+";":"",n+=this.AgendaQuestionReason()?"Основание: "+this.AgendaQuestionReason()+";":"",n+=this.AgendaQuestionIncomingDate()?"Дата поступления: "+this.AgendaQuestionIncomingDate()+";":"",n+=this.AgendaQuestionAddress()?"Адрес объекта: "+this.AgendaQuestionAddress()+";":"",n+=this.AgendaQuestionInvestor()?"Инвестор: "+this.AgendaQuestionInvestor()+";":"",n||this.AgendaQuestionDescription()},this);this.calcReporters=ko.computed(function(){var n=[];return this.agendaQuestionReporterFIO?n.push(this.agendaQuestionReporterFIO().trim()):this.AgendaQuestionReporterFullNameLink()&&n.push(this.AgendaQuestionReporterFullNameLink().get_lookupValue().trim()),this.agendaQuestionSoreporters&&this.agendaQuestionSoreporters()!=null&&this.agendaQuestionSoreporters().length>0?$.each(this.agendaQuestionSoreporters(),function(){n.push(this.ParticipantFullName().trim())}):this.AgendaQuestionSoreporterFullNameLink()!=null&&$.each(this.AgendaQuestionSoreporterFullNameLink(),function(){n.push(this.get_lookupValue().trim())}),n.join("; ")},this);this.mode=ko.observable("full");this.httpLink=ko.observable(String.format("{0}//{1}/Lists/AgendaQuestionList/DispForm.aspx?ID={2}&ContentTypeId={3}",window.location.protocol,window.location.host,u.Id,n.agendaQuestion.ctId));this.changedReporter=ko.observable("");this.changedSoreporters=ko.observable("");this.agendaQuestionObjects=ko.observableArray([]);this.agendaQuestionMeasures=ko.observableArray([]);this.agendaQuestionMeasures(null);this.agendaQuestionAttachments=ko.observableArray([]);this.editAgendaQuestionAttachments=ko.observableArray([]);this.agendaQuestionReporterFIO=ko.observable();this.editAgendaQuestionReporterFIO=ko.observable();this.agendaQuestionReporterPosition=ko.observable();this.editAgendaQuestionReporterPosition=ko.observable();this.agendaQuestionReporterOrganizationName=ko.observable();this.editAgendaQuestionReporterOrganizationName=ko.observable();this.changedReporterIsNull=ko.computed(function(){return!(this.editAgendaQuestionReporterFIO()||this.editAgendaQuestionReporterPosition()||this.editAgendaQuestionReporterOrganizationName())},this);this.agendaQuestionSoreporters=ko.observableArray([]);this.editAgendaQuestionSoreporters=ko.observableArray([]);this.loadReporter=function(){if(this.AgendaQuestionReporterFullNameLink()!=null){var t=this.AgendaQuestionReporterFullNameLink().get_lookupId(),n=$.grep(o,function(n){return n.Id().toString()==t.toString()});n.length>0&&(this.agendaQuestionReporterFIO(n[0].ParticipantFullName()),this.editAgendaQuestionReporterFIO(n[0].ParticipantFullName()),this.agendaQuestionReporterPosition(n[0].ParticipantPosition()),this.editAgendaQuestionReporterPosition(n[0].ParticipantPosition()),this.agendaQuestionReporterOrganizationName(n[0].ParticipantOrg()),this.editAgendaQuestionReporterOrganizationName(n[0].ParticipantOrg()))}}.bind(this);this.loadSoreporters=function(){if(this.AgendaQuestionSoreporterFullNameLink()!=null){var n=[];$.each(this.AgendaQuestionSoreporterFullNameLink(),function(){var i=this.get_lookupId(),t=$.grep(o,function(n){return n.Id().toString()==i.toString()});t.length>0&&n.push(t[0])});this.agendaQuestionSoreporters(n);this.editAgendaQuestionSoreporters(n)}}.bind(this);this.selectReporter=function(){f("Выбор докладчика","#hiddenReporter",!1)}.bind(this);this.showAttachments=function(){vt(String.format("Вложения вопроса повестки №{0}",u.AgendaQuestionNumber),u.Id)};this.showObjects=function(){yt(String.format("Объекты вопроса повестки №{0}",u.AgendaQuestionNumber),this)};this.selectLinkedQuestion=function(){var n={title:"Выбор связанного вопроса",url:_spPageContextInfo.webAbsoluteUrl+"/_layouts/15/gradsovetpages/Pages/SearchQuestion.aspx",width:800,height:400,dialogReturnValueCallback:function(n,t){h(n,t,"#hiddenLinkedQuestion")}};SP.UI.ModalDialog.showModalDialog(n);t()}.bind(this);this.selectSoreporters=function(){f("Выбор содокладчиков","#hiddenSoreporters",!0)}.bind(this);this.removeSoreporter=function(n){this.editAgendaQuestionSoreporters.remove(n);this.editAgendaQuestionSoreporterFullNameLink($.grep(this.editAgendaQuestionSoreporterFullNameLink(),function(t){return t.get_lookupId().toString()!=n.Id().toString()}))}.bind(this);this.onSoreportersChange=ko.computed(function(){var n,t,r;if(this.changedSoreporters()!=""){for(n=$.parseJSON(this.changedSoreporters()),i=0;i<n.length;i++)t=new c(n[i]),ko.utils.arrayFirst(this.editAgendaQuestionSoreporters(),function(n){return t.Id()==n.Id()})||(this.editAgendaQuestionSoreporters.push(t),this.editAgendaQuestionSoreporterFullNameLink()==null&&this.editAgendaQuestionSoreporterFullNameLink([]),r=new SP.FieldLookupValue,r.set_lookupId(n[i].Id),this.editAgendaQuestionSoreporterFullNameLink().push(r));this.changedSoreporters("")}},this);this.onReporterChange=ko.computed(function(){if(this.changedReporter()!=""){var n=$.parseJSON(this.changedReporter()),t=new SP.FieldLookupValue;t.set_lookupId(n[0].Id);this.editAgendaQuestionReporterFullNameLink(t);this.editAgendaQuestionReporterFIO(n[0].ParticipantFullName);this.editAgendaQuestionReporterPosition(n[0].ParticipantPosition);this.editAgendaQuestionReporterOrganizationName(n[0].ParticipantOrg);this.changedReporter("")}},this);this.editQuestionCategoryId=ko.computed({read:function(){return this.editQuestionCategoryLink()?this.editQuestionCategoryLink().get_lookupId():null},write:function(n){if(n){var t=new SP.FieldLookupValue;t.set_lookupId(n);this.editQuestionCategoryLink(t)}else this.editQuestionCategoryLink(null)}},this);this.onLinkedQuestionChange=ko.computed({read:function(){return this.editAgendaLinkedQuestionLinkValue()?this.editAgendaLinkedQuestionLinkValue():""},write:function(n){if(n!=""&&n!=this.editAgendaLinkedQuestionLinkValue()){var t=$.parseJSON(n),i=new SP.FieldLookupValue;i.set_lookupId(t.Id);this.editAgendaLinkedQuestionLink(i);this.editAgendaLinkedQuestionLinkValue(t.AgendaQuestionNumber);this.editAgendaLinkedQuestionLinkId(t.Id)}}},this);this.ListTheme=ko.computed(function(){return this.AgendaQuestionTheme()?this.AgendaQuestionTheme().length>70?this.AgendaQuestionNumber()+". "+this.AgendaQuestionTheme().substring(0,67)+"...":this.AgendaQuestionNumber()+". "+this.AgendaQuestionTheme():null},this);this.accept=function(){for(var n in u)n!="New"&&n!="Id"&&(this[n](this["edit"+n]()),n=="AgendaLinkedQuestionLink"&&(this[n+"Value"](this["edit"+n+"Value"]()),this[n+"Id"](this["edit"+n+"Id"]())));this.agendaQuestionReporterFIO(this.editAgendaQuestionReporterFIO());this.agendaQuestionReporterPosition(this.editAgendaQuestionReporterPosition());this.agendaQuestionReporterOrganizationName(this.editAgendaQuestionReporterOrganizationName());this.agendaQuestionSoreporters(this.editAgendaQuestionSoreporters());this.agendaQuestionAttachments(this.editAgendaQuestionAttachments())}.bind(this);this.cancel=function(){for(var n in u)n!="New"&&n!="Id"&&(this["edit"+n](this[n]()),n=="AgendaLinkedQuestionLink"&&(this["edit"+n+"Value"](this[n+"Value"]()),this["edit"+n+"Id"](this[n+"Id"]())));this.editAgendaQuestionReporterFIO(this.agendaQuestionReporterFIO());this.editAgendaQuestionReporterPosition(this.agendaQuestionReporterPosition());this.editAgendaQuestionReporterOrganizationName(this.agendaQuestionReporterOrganizationName());this.editAgendaQuestionSoreporters(this.agendaQuestionSoreporters());this.editAgendaQuestionAttachments(this.agendaQuestionAttachments())}.bind(this);this.addQuestionAttachment=function(){this.editAgendaQuestionAttachments.push(new r({Id:"",AttachmentDescription:"",MeetingLink:this.Id(),FileUrl:"",FileName:"",FilePath:"",AttachmentDocumentTypeLinkValue:"",New:!0}))}.bind(this);this.removeQuestionAttachment=function(n){this.editAgendaQuestionAttachments.destroy(n)}.bind(this);this.selectAgendaQuestionProjectType=function(n,t){this.editAgendaQuestionProjectType(t.label)}.bind(this);this.editQuestionComment=function(){ShowCommentWindow(this)}}function ii(n){for(var t in n)t=="New"?this[t]=n[t]:t=="Id"?this[t]=ko.observable(n[t]):(this[t]=ko.observable(n[t]),this["edit"+t]=ko.observable(n[t]),t=="AgendaLinkedQuestionLink"&&(this[t+"Value"]=ko.observable(n[t]?n[t].get_lookupValue():null),this[t+"Id"]=ko.observable(n[t]?n[t].get_lookupId():null),this["edit"+t+"Value"]=ko.observable(n[t]?n[t].get_lookupValue():null),this["edit"+t+"Id"]=ko.observable(n[t]?n[t].get_lookupId():null)))}function r(n){this.Id=ko.observable(n.Id);this.Descr=ko.observable(n.AttachmentDescription);this.MeetingLink=ko.observable(n.MeetingLink);this.FileUrl=ko.observable(n.FileUrl);this.FileName=ko.observable(n.FileName);this.FilePath=ko.observable(n.FilePath);this.DType=ko.observable(n.AttachmentDocumentTypeLinkValue);this.IsForReport=ko.observable(n.AttachmentIsForReport);this.New=n.New;this.File=ko.observable();this.selectedFile=function(n){n.files==undefined?this.File=n.files:this.File(n.files[0])}.bind(this)}function c(n){this.Id=ko.observable(n.Id);this.ParticipantFullName=ko.observable(n.ParticipantFullName);this.ParticipantPosition=n.ParticipantPositionLink!=undefined?ko.observable(n.ParticipantPositionLink.Title):ko.observable(n.ParticipantPosition);this.ParticipantOrg=n.ParticipantOrgLink!=undefined?ko.observable(n.ParticipantOrgLink.OrganizationName):ko.observable(n.ParticipantOrg);this.ParticipantRole=ko.observable(n.ParticipantRole)}function g(n){for(var t in n)this[t]=t=="New"?n[t]:ko.observable(n[t]);this.changeTitle=ko.computed(function(){var n=this.MeetingNumber(),t=new Date,i=this.CreatedDate==undefined?t.getFullYear():+this.CreatedDate().split("/")[2];this.MeetingTitle(n+"-"+i)},this);this.ChairManFullNameLinkValue=ko.observable(this.ChairManFullNameLink()?this.ChairManFullNameLink().get_lookupValue():null);this.ChairManFullNameLinkId=ko.computed({read:function(){return this.ChairManFullNameLink()?this.ChairManFullNameLink().get_lookupId():null},write:function(n){var t=$.parseJSON(n);this.ChairManFullNameLink(s(t[0].Id));this.ChairManFullNameLinkValue(t[0].ParticipantFullName)}},this);this.selectChairMan=function(){f("Выбор председателя","#hidden-meeting-chair-man",!1)}.bind(this);this.ProtocolResponsibleSecretaryLinkValue=ko.observable(this.ProtocolResponsibleSecretaryLink()?this.ProtocolResponsibleSecretaryLink().get_lookupValue():null);this.ProtocolResponsibleSecretaryLinkId=ko.computed({read:function(){return this.ProtocolResponsibleSecretaryLink()?this.ProtocolResponsibleSecretaryLink().get_lookupId():null},write:function(n){var t=$.parseJSON(n);this.ProtocolResponsibleSecretaryLink(s(t[0].Id));this.ProtocolResponsibleSecretaryLinkValue(t[0].ParticipantFullName)}},this);this.selectResponsibleSecretary=function(){f("Выбор ответственного секретаря","#hidden-responsible-secretary",!1)}.bind(this);this.SecretaryFullNameLinkValue=ko.observable(this.SecretaryFullNameLink()?this.SecretaryFullNameLink().get_lookupValue():null);this.SecretaryFullNameLinkId=ko.computed({read:function(){return this.SecretaryFullNameLink()?this.SecretaryFullNameLink().get_lookupId():null},write:function(n){var t=$.parseJSON(n);this.SecretaryFullNameLink(s(t[0].Id));this.SecretaryFullNameLinkValue(t[0].ParticipantFullName)}},this);this.selectSecretary=function(){f("Выбор секретаря","#hidden-secretary",!1)}.bind(this);this.additionalParticipants=ko.observableArray(d(n.ProtocolExtParticipants));this.selectAdditionalParticipants=function(){f("Выбор остальных участников","#hidden-additioanl-participants",!0)}.bind(this);this.AdditionalParticipantsInput=ko.computed({read:function(){return""},write:function(n){var u=$.parseJSON(n),t,r;for(i=0;i<u.length;i++)t=new c(u[i]),ko.utils.arrayFirst(this.additionalParticipants(),function(n){return t.Id()==n.Id()})||(this.additionalParticipants.push(t),this.ProtocolExtParticipants()==null&&this.ProtocolExtParticipants([]),r=new SP.FieldLookupValue,r.set_lookupId(t.Id()),this.ProtocolExtParticipants().push(r))}},this);this.removeAdditionalPartcipant=function(n){this.additionalParticipants.remove(n);this.ProtocolExtParticipants($.grep(this.ProtocolExtParticipants(),function(t){return t.get_lookupId().toString()!=n.Id().toString()}))}.bind(this)}function y(n,t){for(var r,u,i={},f=0;f<n.length;f++){r=n[f].get_internalName();try{u=t.get_item(r)}catch(e){console.log("Не удалось обнаружить поле "+r)}i[r]=r.toLowerCase().indexOf("date")>=0&&u?w(u):u}i.Id=t.get_item("ID");try{i.Author=t.get_item("Author").get_lookupValue()}catch(e){console&&console.log("Не удалось обнаружить поле Author: "+e.message)}return i.CreatedDate=w(t.get_item("Created")),i.New=!1,i}function u(n,t,i){for(var r,u=0;u<n.length;u++)r=n[u].get_internalName(),r.toLowerCase().indexOf("date")>=0?t[r]()?i.set_item(r,it(t[r]())):i.set_item(r,null):i.set_item(r,t[r]())}function e(n){for(var r,t={},i=0;i<n.length;i++)r=n[i].get_internalName(),t[r]=n[i].get_defaultValue();return t.Id="",t.New=!0,t}function nt(n,t){for(var r,u={},i=0;i<n.length;i++)r=n[i].get_internalName(),u[r]=t[r]();return u}function ri(){var t=this;t.initFileReader=function(){};t.allProjectsTypes=ko.observableArray([]);t.allQuestions=ko.observableArray([]);t.currentMeetingsNumber=ko.observable();t.meeting=ko.observable({});t.agendaQuestions=ko.observableArray([]);t.agendaQuestionObjects=ko.observableArray([]);t.agendaQuestionTypes=ko.observableArray([]);t.assignmentTypes=ko.observableArray([]);t.assignments=ko.observableArray([]);t.filteredAssignments=function(n){return ko.utils.arrayFilter(t.assignments(),function(t){return t.editAgendaQuestionLinkValue().toString()===n.toString()})};t.availableMeetingStatuses=ko.observableArray([]);t.assignmentStatuses=ko.observableArray([]);t.assignmentReportResolutions=ko.observableArray([]);t.assignmentInspectStates=ko.observableArray([]);t.assignmentDayTypes=ko.observableArray([]);t.availableAttachDocTypes=ko.observableArray([]);t.attachments=ko.observableArray([]);t.scanAttach=ko.observable(new r({AttachmentDescription:"",MeetingLink:"",Id:"",FileUrl:"",FileName:"",FilePath:"",AttachmentDocumentTypeLinkValue:"",New:!0}));t.editEnabled=ko.observable();t.isReporter=ko.observable();var s=$.appWebContext.get_web().get_lists().getByTitle("Заседания"),f=$.appWebContext.get_web().get_lists().getByTitle("Вопросы повестки заседания"),p=$.appWebContext.get_web().get_lists().getByTitle("Объекты вопросов повестки"),i=$.appWebContext.get_web().get_lists().getByTitle("Вложения заседаний"),h=$.appWebContext.get_web().get_lists().getByTitle("Поручения"),w=$.appWebContext.get_web().get_lists().getByTitle("Типы документов вложений"),a=$.appWebContext.get_web().get_lists().getByTitle("Типы проектов вопросов повестки"),c=new Spinner(tt);wt(function(){ht();t.getPermissions();t.loadData()});t.getPermissions=function(){t.editEnabled(!1)};t.loadData=function(){var h,l,st,b,nt,ht,tt,it,u;t.availableMeetingStatuses(ut(n.meeting.fields,"MeetingStatus"));var rt=new SP.CamlQuery,ft=w.getItems(rt),ot=a.getItems(rt);$.appWebContext.load(ft);$.appWebContext.load(ot);$.appWebContext.executeQueryAsync(function(){for(var n=ft.getEnumerator(),i;n.moveNext();)t.availableAttachDocTypes().push({id:n.get_current().get_item("ID"),name:n.get_current().get_item("Title")});for(n=ot.getEnumerator(),i=[];n.moveNext();)i.push({label:n.get_current().get_item("Title"),value:n.get_current().get_item("Title")});t.allProjectsTypes(i)});t.currentMeetingsNumber(et());$.pageMode=="new"||$.listItemId=="undefined"?(t.meeting(new g(e(n.meeting.fields))),t.meeting().MeetingNumber(t.currentMeetingsNumber()+1)):(h=new SP.CamlQuery,h.set_viewXml("<View><Query><Where><Eq><FieldRef Name='ID'/><Value Type='Text'>"+$.listItemId+"<\/Value><\/Eq><\/Where><\/Query><\/View>"),l=s.getItems(h),$.appWebContext.load(l),st=(new CamlBuilder).Where().LookupField("MeetingLink").Id().EqualTo($.listItemId).OrderBy("AgendaQuestionNumber"),b=new SP.CamlQuery,b.set_viewXml("<View><Query>"+st.ToString()+"<\/Query><\/View>"),nt=f.getItems(b),$.appWebContext.load(nt),ht=(new CamlBuilder).Where().LookupField("MeetingLink").Id().EqualTo($.listItemId),tt=new SP.CamlQuery,tt.set_viewXml("<View><Query>"+ht.ToString()+"<\/Query><\/View>"),it=i.getItems(tt),$.appWebContext.load(it),u=document.getElementById("AgendaQuestionTableDiv"),u&&($(u.children).each(function(n,t){$(t).hide()}),$(u).css("min-height","150px"),c.spin(u)),$.appWebContext.executeQueryAsync(function(){var f,w,b,tt,rt,ut,ft,h,e;try{t.meeting(new g(y(n.meeting.fields,l.get_data()[0])));for(var s=[],a=[],i=nt.getEnumerator();i.moveNext();)f=new v(y(n.agendaQuestion.fields,i.get_current())),f.AgendaQuestionReporterFullNameLink()!=null&&a.push(f.AgendaQuestionReporterFullNameLink()),f.AgendaQuestionSoreporterFullNameLink!=null&&$.each(f.AgendaQuestionSoreporterFullNameLink(),function(){a.push(this)}),s.push(f);for(t.agendaQuestions(s),w=[],i=it.getEnumerator();i.moveNext();)rt=i.get_current().get_item("AttachmentDocumentTypeLink"),ut=k("Вложения заседаний",i.get_current().get_item("ID")),tt=new r({AttachmentDescription:i.get_current().get_item("AttachmentDescription"),MeetingLink:i.get_current().get_item("MeetingLink"),Id:i.get_current().get_item("ID"),FileUrl:ut.FileUrl,FileName:ut.FileName,FilePath:"",AttachmentDocumentTypeLinkValue:rt?rt.get_lookupId():"",New:!1}),i.get_current().get_item("AttachmentProtocolScanCopy")?b=tt:w.push(tt);t.attachments(w);b&&t.scanAttach(b);h=(new CamlBuilder).Where().LookupField("_x0412__x043e__x043f__x0440__x04").Id().In($.map(t.agendaQuestions(),function(n){return n.Id()}));e=new SP.CamlQuery;e.set_viewXml("<View><Query>"+h.ToString()+"<\/Query><\/View>");ft=p.getItems(e);$.appWebContext.load(ft);h=(new CamlBuilder).Where().LookupField("AgendaQuestionLink").Id().In($.map(t.agendaQuestions(),function(n){return n.Id()}));e=new SP.CamlQuery;e.set_viewXml("<View><Query>"+h.ToString()+"<\/Query><\/View>");$.appWebContext.executeQueryAsync(function(){for(var i=[],p=[],c=ft.getEnumerator(),f,l,u,e,h,r,v;c.moveNext();)f=y(n.agendaQuestionObject.fields,c.get_current()),l=new ii(f),p.push(f),i.push(l);for(t.agendaQuestionObjects(i),u=0;u<s.length;u++){for(e=s[u],r=0;r<i.length;r++)i[r]._x0412__x043e__x043f__x0440__x04().get_lookupId()==e.Id()&&(h=i[r]);h&&e.agendaQuestionObjects.push(h)}v=[];t.assignments(v);o=d(a);$.each(t.agendaQuestions(),function(){this.loadReporter();this.loadSoreporters()});$.each(t.assignments(),function(){this.loadExecutor();this.loadSoexecutors()})})}finally{c.stop();u&&($(u.children).each(function(n,t){$(t).show()}),$(u).css("min-height","0px"))}},function(){c.stop();u&&($(u.children).each(function(n,t){$(t).show()}),$(u).css("min-height","0px"))}))};t.selectedAgendaQuestion=ko.observable();t.selectedAssignment=ko.observable();t.editAssignment=function(n){n.selectedRequest(undefined);t.selectedAssignment(n)};t.addAssignment=function(){var i=e(n.assignment.fields),r=new ti(i);t.selectedAssignment(r);t.selectedAssignment().editAssignmentNumber(t.assignments().length+1);t.selectedAssignment().Id("");t.assignments.push(t.selectedAssignment())};t.removeAssignment=function(n){t.assignments.destroy(n)};t.acceptAssignment=function(){var n=t.selectedAssignment();b(n.editAssignmentNumber())?(n.accept(),n.New&&(n.New=!1),t.selectedAssignment("")):alert("Номер поручения должен быть числом > 0!")};t.cancelAssignment=function(){t.selectedAssignment().New?t.assignments.remove(t.selectedAssignment()):t.selectedAssignment().cancel();t.selectedAssignment("")};t.editAgendaQuestion=function(n){n.mode("full");t.selectedAgendaQuestion(n)};t.editAgendaQuestionOnlyFiles=function(n){n.mode("onlyFiles");t.selectedAgendaQuestion(n)};t.addAgendaQuestion=function(){var i=e(n.agendaQuestion.fields);i.MeetingLink=t.meeting().MeetingNumber();t.selectedAgendaQuestion(new v(i));t.selectedAgendaQuestion().editAgendaQuestionNumber(t.agendaQuestions().length+1);t.selectedAgendaQuestion().mode("full")};t.addIssueP=function(){pt("Добавить плановые вопросы")};t.removeAgendaQuestion=function(n){var i=$.grep(t.assignments(),function(t){return t.AgendaQuestionLinkValue()==n.AgendaQuestionNumber()});i.length>0?alert("На данный вопрос ссылаются поручения. Чтобы удалить этот вопрос, сначала необходимо удалить все поручения и сохранить документ."):t.agendaQuestions.destroy(n)};t.acceptAgendaQuestion=function(){var i=t.selectedAgendaQuestion(),r,e;b(i.editAgendaQuestionNumber())?(i.accept(),i.New?(r=nt(n.agendaQuestion.fields,i),r.agendaQuestionReporterFIO=i.agendaQuestionReporterFIO(),r.agendaQuestionSoreporters=i.agendaQuestionSoreporters(),e=f.addItem(new SP.ListItemCreationInformation),u(n.agendaQuestion.fields,i,e),e.update(),$.appWebContext.load(e),$.appWebContext.executeQueryAsync(function(){r.Id=e.get_id();r.New=!1;r.MeetingLink=t.meeting().MeetingNumber();t.agendaQuestions.push(new v(r));t.selectedAgendaQuestion("")})):t.selectedAgendaQuestion("")):alert("Номер вопроса должен быть числом > 0!")};t.cancelAgendaQuestion=function(){t.selectedAgendaQuestion().cancel();t.selectedAgendaQuestion("")};t.addAttach=function(){t.attachments.push(new r({Id:"",AttachmentDescription:"",MeetingLink:t.meeting().MeetingNumber(),FileUrl:"",FileName:"",FilePath:"",AttachmentDocumentTypeLinkValue:"",New:!0}))};t.removeAttach=function(n){t.attachments.destroy(n)};t.deleteScanAttach=function(){var n=i.getItemById(t.scanAttach().Id());n.deleteObject();$.appWebContext.executeQueryAsync(function(){t.scanAttach(new r({AttachmentDescription:"",MeetingLink:t.meeting().Id(),Id:"",FileUrl:"",FileName:"",FilePath:"",AttachmentDocumentTypeLinkValue:"",New:!0}))})};t.showPlaceOnMap=function(){t.meeting().MeetingPlace()!=""&&window.open("http://maps.yandex.ru/?text="+t.meeting().MeetingPlace(),"_blank")};t.closeForm=function(){window.location.href=$.backUrl};t.save=function(){var e,r,o;if(isNaN(t.meeting().MeetingNumber())){alert("Ошибка при сохранении! Номер заседания должен быть числом!");return}if(t.meeting().New){if(t.currentMeetingsNumber()>t.meeting().MeetingNumber()){alert("Ошибка при сохранении! Заданный номер заседания меньше последнего существующего!");return}ft(t.meeting().MeetingNumber());r=s.addItem(new SP.ListItemCreationInformation);u(n.meeting.fields,t.meeting(),r);r.update();e=r;$.appWebContext.load(r)}else o=s.getItemById(t.meeting().Id()),u(n.meeting.fields,t.meeting(),o),o.update();$.appWebContext.executeQueryAsync(function(){var k,c,y,v,s,p,w,b,o,r;e&&(t.meeting().Id(e.get_id()),t.meeting().New=!1);k=[];for(c in t.agendaQuestions())t.agendaQuestions()[c]._destroy?t.agendaQuestions()[c].Id()!=""&&(r=f.getItemById(t.agendaQuestions()[c].Id()),r.deleteObject()):(r=f.getItemById(t.agendaQuestions()[c].Id()),u(n.agendaQuestion.fields,t.agendaQuestions()[c],r),r.set_item("MeetingLink",t.meeting().Id()),r.update(),y=rt(t.allProjectsTypes(),t.agendaQuestions()[c].AgendaQuestionProjectType(),a),y!=null&&t.allProjectsTypes.push({label:y,value:y}));v=[];for(s in t.assignments())t.assignments()[s]._destroy?t.assignments()[s].Id()!=""&&(r=h.getItemById(t.assignments()[s].Id()),r.deleteObject()):(r=t.assignments()[s].Id()==""?h.addItem(new SP.ListItemCreationInformation):h.getItemById(t.assignments()[s].Id()),u(n.assignment.fields,t.assignments()[s],r),p=$.grep(t.agendaQuestions(),function(n){return n.AgendaQuestionNumber()==t.assignments()[s].AgendaQuestionLinkValue()}),p.length>0&&(p.length>1&&console.log("Duplicate agenda question numbers in this meeting"),r.set_item("AgendaQuestionLink",p[0].Id())),r.update(),t.assignments()[s].Id()==""&&(v.push({spItem:r,koItem:t.assignments()[s]}),$.appWebContext.load(r)));w=[];b=[];for(o in t.attachments())t.attachments()[o]._destroy?t.attachments()[o].Id()!=""&&(r=i.getItemById(t.attachments()[o].Id()),r.deleteObject()):(r=t.attachments()[o].Id()==""&&t.attachments()[o].File()!=undefined?i.addItem(new SP.ListItemCreationInformation):i.getItemById(t.attachments()[o].Id()),r.set_item("AttachmentDescription",t.attachments()[o].Descr()),r.set_item("MeetingLink",t.meeting().Id()),r.set_item("AttachmentDocumentTypeLink",t.attachments()[o].DType()),r.set_item("AttachmentProtocolScanCopy",!1),r.update(),t.attachments()[o].Id()==""&&t.attachments()[o].File()!=undefined&&(w.push({spItem:r,koItem:t.attachments()[o]}),$.appWebContext.load(r)));t.scanAttach()._destroy||t.scanAttach().File()!=undefined&&(r=t.scanAttach().Id()==""?i.addItem(new SP.ListItemCreationInformation):i.getItemById(t.scanAttach().Id()),r.set_item("AttachmentDescription",t.scanAttach().Descr()),r.set_item("MeetingLink",t.meeting().Id()),r.set_item("AttachmentProtocolScanCopy",!0),r.update(),t.scanAttach().Id()==""&&(b.push({spItem:r,koItem:t.scanAttach()}),$.appWebContext.load(r)));$.appWebContext.executeQueryAsync(function(){for(var r,i,n=t.agendaQuestions().length-1;n>=0;n--)t.agendaQuestions()[n]._destroy&&t.agendaQuestions.splice(n,1);l(b,"Вложения заседаний");l(w,"Вложения заседаний");for(r in v)v[r].koItem.Id(v[r].spItem.get_id()),v[r].koItem.New=!1;for(n=t.assignments().length-1;n>=0;n--)t.assignments()[n]._destroy&&t.assignments.splice(n,1);for(n=t.attachments().length-1;n>=0;n--)t.attachments()[n]._destroy&&t.attachments.splice(n,1);ct(t.assignments());i=lt(t.assignments());$.appWebContext.executeQueryAsync(function(){var n,r;for(n in i)i[n].koItem.Id(i[n].spItem.get_id()),i[n].koItem.New=!1;r=st(t.assignments());$.appWebContext.executeQueryAsync(function(){l(r,"Вложения отчета по поручению");$.appWebContext.executeQueryAsync(function(){alert("Успешно сохранено")},function(){alert("Ошибка при сохранении вложений Отчетов!")})},function(){alert("Ошибка при сохранении вложений Отчетов!")})},function(){alert("Не могу сохранить данные отчётов!")})},function(n,t){alert("Ошибка обновления данных заседания");console.log(t.get_message())})},function(n,t){alert("Error saving new meeting");console.log(t.get_message())})}}function ui(){$.appWebContext=SP.ClientContext.get_current();SP.SOD.executeOrDelayUntilScriptLoaded(function(){ko.applyBindings(new ri)},"sp.js")}var tt={lines:13,length:20,width:10,radius:30,corners:1,rotate:0,direction:1,color:"#000",speed:1.7,trail:60,shadow:!1,hwaccel:!1,className:"spinner",zIndex:2e9,top:"auto",left:"auto"},p,n={meeting:{listName:"Заседания",ctName:"Заседание",ctId:"0x0100EC243C589FF24FEFBF00F3D3FE6ECD36",fields:[]},agendaQuestion:{listName:"Вопросы повестки заседания",ctName:"Вопрос повестки",ctId:"0x01004682F4FBB1874837BA39C57EED443E7C",fields:[]},agendaQuestionObject:{listName:"Объекты вопросов повестки",ctName:"Объект вопроса",ctId:"0x0100801A9BF42D9CF441A8DE498AE7E2F2E2",fields:[]}},o=[];ko.bindingHandlers.iconButton={init:function(n,t){var i=t()||{};$(n).button(i)}};ko.bindingHandlers.datePicker={init:function(n,t){var i=t()||{};$(n).datepicker(i)}};ko.bindingHandlers.accordion={init:function(n,t){var i=t()||{};$(n).accordion(i)}};ko.bindingHandlers.jqDialog={init:function(n,t){var i=ko.utils.unwrapObservable(t())||{};ko.utils.domNodeDisposal.addDisposeCallback(n,function(){$(n).dialog("destroy")});$(n).dialog(i)}};ko.bindingHandlers.openDialog={update:function(n,t){var i=ko.utils.unwrapObservable(t());i?$(n).dialog("open"):$(n).dialog("close")}};ko.bindingHandlers.jqDialogButton={init:function(n,t){var i=ko.utils.unwrapObservable(t())||{};ko.utils.domNodeDisposal.addDisposeCallback(n,function(){$(n).button("destroy")});$(n).button(i)}};ko.bindingHandlers.showModal={init:function(){},update:function(n,t){var i=t();ko.utils.unwrapObservable(i)?$(n).modal("show"):$(n).modal("hide")}};ko.bindingHandlers.jqAuto={init:function(n,t){$(n).autocomplete(t())},update:function(n,t){$(n).autocomplete("option","source",t().source)}};$(document).ready(function(){$.hostweburl=decodeURIComponent($.getUrlVar("SPHostUrl"));$.pageMode=decodeURIComponent($.getUrlVar("mode"));$.backUrl=decodeURIComponent($.getUrlVar("Source"));$.listItemId=decodeURIComponent($.getUrlVar("ID"));moment.lang("ru");SP.SOD.executeFunc("sp.js","SP.ClientContext",ui)})})();
/*
//# sourceMappingURL=viewmodel.min.js.map
*/